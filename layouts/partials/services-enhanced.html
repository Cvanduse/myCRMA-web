{{ with site.GetPage "sections/services" }}
  {{ if .Params.enable }}
    <section id="services" class="services-section-enhanced">
      <!-- Animated Background -->
      <div class="animated-bg"></div>
      
      <!-- Full Width Interactive Arrow Bar -->
      <div class="interactive-arrow-bar">
        <div class="arrow-grid-bg" id="arrow-grid" aria-hidden="true"></div>
        <div class="glass-overlay-title">
          <h2>{{ .Title | markdownify }}</h2>
        </div>
      </div>

      <div class="container">
        
        <!-- Header Wrapper -->
        <div class="services-header-wrapper">
          <!-- Static Description (Outside/Below) -->
          <div class="static-description">
            <p>{{ .Params.description | markdownify }}</p>
          </div>
        </div>

        <div class="services-grid">
          {{ range $index, $element := .Params.services }}
            <div class="service-card {{ if ge $index 3 }}hidden-service{{ end }}" data-service="{{ .title | urlize }}" style="{{ if ge $index 3 }}display: none;{{ end }}">
              <div class="service-icon-container">
                <div class="icon-bg-animation"></div>
                {{ if .icon_svg }}
                  {{ .icon_svg | safeHTML }}
                {{ else }}
                  <svg class="service-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                    <path d="M2 17L12 22L22 17"/>
                    <path d="M2 12L12 17L22 12"/>
                  </svg>
                {{ end }}
              </div>
              
              <h3 class="service-title">{{ .title | markdownify }}</h3>
              {{ if .pricing }}
                <div class="pricing-badge">
                  <span class="price">{{ .pricing.price }}</span>
                  <span>{{ .pricing.duration }}</span>
                </div>
              {{ end }}
              <p class="service-description">{{ .description | markdownify }}</p>
              
              {{ if .metrics }}
                <div class="success-metrics">
                  {{ range .metrics }}
                    <div class="metric">
                      <span class="metric-value">{{ .value }}</span>
                      <span class="metric-label">{{ .label }}</span>
                    </div>
                  {{ end }}
                </div>
              {{ end }}

              <div class="learn-more">
                <div class="learn-more-toggle" role="button" aria-expanded="false" tabindex="0" onclick="toggleLearnMore(this)" onkeydown="if(event.key === 'Enter' || event.key === ' ') { toggleLearnMore(this); event.preventDefault(); }">
                  <span>Learn More</span>
                  <svg class="arrow" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7 10l5 5 5-5z"/>
                  </svg>
                </div>
                <div class="learn-more-content">
                  {{ if .features }}
                    <ul class="feature-list">
                      {{ range .features }}
                        <li>{{ . }}</li>
                      {{ end }}
                    </ul>
                  {{ end }}
                  <a href="{{ .link | default '#' }}" class="service-cta">Get Started →</a>
                </div>
              </div>
            </div>
          {{ end }}
        </div>

        <div class="services-expand-container">
          <!-- Static Arrow Grid Background -->
          <div class="static-arrow-grid" id="static-arrow-grid" aria-hidden="true"></div>

          <div class="expand-connector"></div>
          <button id="toggle-services-btn" class="btn-expand-services" onclick="toggleServices()">
            <span class="btn-text">View Additional Services</span>
            <span class="btn-icon">
              <i class="fa fa-plus"></i>
            </span>
          </button>
        </div>

      </div>

      <style>
        /* Enhanced Services Section Styles */
        .services-section-enhanced {
          position: relative;
          background: var(--color-off-white); /* Match section background */
          color: var(--color-charcoal);
          overflow: hidden;
          padding: 40px 0 80px 0;
        }

        /* Background Animation */
        .animated-bg {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: linear-gradient(135deg, var(--color-off-white) 0%, var(--color-light-gray) 100%);
          z-index: -2;
        }

        .animated-bg::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-image: 
            radial-gradient(circle at 20% 50%, rgba(120, 80, 255, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(80, 120, 255, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 40% 20%, rgba(255, 80, 120, 0.03) 0%, transparent 50%);
          animation: bgPulse 20s ease-in-out infinite;
        }

        @keyframes bgPulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.8; }
        }

        /* Container */
        .container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 0 20px;
          position: relative;
          z-index: 1;
        }

        /* --- New Header Layout --- */
        .services-header-wrapper {
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-bottom: 60px;
        }

        /* 1. Interactive Bar */
        .interactive-arrow-bar {
          position: relative;
          width: 100%;
          height: 200px; /* Increased height for full-width impact */
          overflow: hidden;
          background: transparent; 
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 40px; /* Space below the bar */
        }

        .arrow-grid-bg {
          position: absolute;
          top: 0; left: 0; width: 100%; height: 100%;
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
          grid-template-rows: repeat(auto-fill, minmax(40px, 1fr));
          gap: 0;
          z-index: 1;
          pointer-events: none;
        }

        .arrow-cell {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          height: 100%;
        }

        .arrow-icon {
          width: 10px;
          height: 10px;
          /* Amber arrows */
          border-right: 2px solid var(--color-warm-amber);
          border-bottom: 2px solid var(--color-warm-amber);
          transform-origin: center;
          transform: rotate(45deg); 
          opacity: 0.8;
          /* Removed transition for immediate mouse tracking */
        }

        .glass-overlay-title {
          position: relative;
          z-index: 10;
          /* Stronger Glass effect for legibility over arrows */
          background: rgba(255, 255, 255, 0.85);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          padding: 15px 50px;
          border-radius: 50px;
          border: 1px solid rgba(255, 255, 255, 0.5);
          box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .glass-overlay-title h2 {
          font-size: 2.5rem;
          font-weight: 800;
          margin: 0;
          color: var(--color-slate-blue); /* Brand Blue Text */
          font-family: var(--font-headline);
          text-align: center;
        }

        /* 2. Static Description (Below Bar) */
        .static-description {
          text-align: center;
          max-width: 700px;
          margin: 0 auto;
          animation: fadeInUp 0.8s ease-out;
        }

        .static-description p {
          font-size: 1.25rem;
          line-height: 1.6;
          color: var(--color-charcoal);
          font-weight: 500;
        }

        /* Service Cards Grid */
        .services-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
          gap: 30px;
          margin-bottom: 60px;
        }

        /* Service Card */
        .service-card {
          background: var(--color-off-white);
          border: 1px solid var(--color-light-gray);
          border-radius: 24px;
          padding: 40px;
          position: relative;
          overflow: hidden;
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          cursor: pointer;
          animation: fadeInUp 0.8s ease-out forwards;
          opacity: 0;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Show initial cards and ensure animation works */
        .service-card:not(.hidden-service) {
            opacity: 0; /* Start hidden for animation */
        }
        
        /* Styles for hidden services when revealed */
        .service-card.revealed {
            display: block !important;
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .service-card:nth-child(1) { animation-delay: 0.1s; --service-color: var(--color-slate-blue); }
        .service-card:nth-child(2) { animation-delay: 0.2s; --service-color: var(--color-warm-amber); }
        .service-card:nth-child(3) { animation-delay: 0.3s; --service-color: var(--color-success-teal); }
        .service-card:nth-child(4) { animation-delay: 0.4s; --service-color: var(--color-error-coral); }
        .service-card:nth-child(5) { animation-delay: 0.5s; --service-color: var(--color-slate-blue); }
        .service-card:nth-child(6) { animation-delay: 0.6s; --service-color: var(--color-warm-amber); }

        .service-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: linear-gradient(135deg, var(--service-color) 0%, transparent 60%);
          opacity: 0;
          transition: opacity 0.4s ease;
          z-index: -1;
        }

        .service-card:hover {
          transform: translateY(-10px) scale(1.02);
          border-color: var(--service-color);
          background: #ffffff;
          box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.15),
            0 0 60px rgba(75, 101, 135, 0.1);
        }

        .service-card:hover::before {
          opacity: 0.1;
        }

        /* Service Icon Container */
        .service-icon-container {
          width: 80px;
          height: 80px;
          background: linear-gradient(135deg, var(--service-color) 0%, transparent 100%);
          border-radius: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 30px;
          position: relative;
          overflow: hidden;
        }

        .service-icon {
          width: 40px;
          height: 40px;
          filter: brightness(0) invert(1);
          z-index: 1;
          transition: transform 0.3s ease;
        }

        .service-card:hover .service-icon {
          transform: scale(1.1) rotate(5deg);
        }

        /* Animated Icon Background */
        .icon-bg-animation {
          position: absolute;
          width: 100%;
          height: 100%;
          background: radial-gradient(circle, var(--service-color) 0%, transparent 70%);
          opacity: 0.3;
          animation: iconPulse 3s ease-in-out infinite;
        }

        @keyframes iconPulse {
          0%, 100% { transform: scale(1); opacity: 0.3; }
          50% { transform: scale(1.2); opacity: 0.1; }
        }

        /* Service Content */
        .service-title {
          font-size: 1.75rem;
          font-weight: 600;
          margin-bottom: 15px;
          color: var(--color-charcoal);
        }

        .service-description {
          color: var(--color-slate-blue);
          margin-bottom: 25px;
          line-height: 1.7;
          transition: color 0.3s ease;
        }

        .service-card:hover .service-description {
          color: var(--color-charcoal);
        }

        /* Pricing Badge */
        .pricing-badge {
          display: inline-flex;
          align-items: center;
          background: var(--color-off-white);
          border: 1px solid var(--color-light-gray);
          border-radius: 12px;
          padding: 8px 16px;
          margin-bottom: 20px;
          font-size: 0.875rem;
          transition: all 0.3s ease;
          color: var(--color-slate-blue);
        }

        .pricing-badge .price {
          color: var(--service-color);
          font-weight: 600;
          margin-right: 5px;
        }

        .service-card:hover .pricing-badge {
          background: #ffffff;
          border-color: var(--service-color);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Success Metrics */
        .success-metrics {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 15px;
          margin: 25px 0;
          opacity: 0;
          max-height: 0;
          overflow: hidden;
          transition: all 0.4s ease;
        }

        .service-card:hover .success-metrics {
          opacity: 1;
          max-height: 100px;
        }

        .metric {
          background: #ffffff;
          border: 1px solid var(--color-light-gray);
          border-radius: 12px;
          padding: 12px;
          text-align: center;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
          font-size: 1.5rem;
          font-weight: 700;
          color: var(--service-color);
          display: block;
        }

        .metric-label {
          font-size: 0.75rem;
          color: var(--color-slate-blue);
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        /* Learn More Section */
        .learn-more {
          margin-top: 30px;
          padding-top: 25px;
          border-top: 1px solid var(--color-light-gray);
        }

        .learn-more-toggle {
          display: flex;
          align-items: center;
          justify-content: space-between;
          cursor: pointer;
          color: var(--service-color);
          font-weight: 500;
          transition: all 0.3s ease;
        }

        .learn-more-toggle:hover {
          color: var(--color-charcoal);
        }

        .arrow {
          width: 24px;
          height: 24px;
          transition: transform 0.3s ease;
        }

        .learn-more-toggle.active .arrow {
          transform: rotate(180deg);
        }

        .learn-more-content {
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.4s ease;
          margin-top: 0;
        }

        .learn-more-content.active {
          max-height: 300px;
          margin-top: 20px;
        }

        .feature-list {
          list-style: none;
          padding: 0;
        }

        .feature-list li {
          padding: 8px 0;
          padding-left: 30px;
          position: relative;
          color: var(--color-slate-blue);
        }

        .feature-list li::before {
          content: "✓ ";
          position: absolute;
          left: 0;
          color: var(--service-color);
          font-weight: bold;
        }

        /* CTA Button */
        .service-cta {
          display: inline-flex;
          align-items: center;
          background: linear-gradient(135deg, var(--service-color) 0%, var(--service-color) 100%);
          color: #ffffff;
          padding: 12px 24px;
          border-radius: 12px;
          text-decoration: none;
          font-weight: 500;
          margin-top: 20px;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .service-cta::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.2);
          transition: left 0.3s ease;
        }

        .service-cta::after {
          left: 100%;
        }

        .service-cta:hover {
          transform: translateX(5px);
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Expand Services Button Styles */
        .services-expand-container {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          margin-top: 40px;
          position: relative;
          z-index: 10;
          width: 100%;
          padding: 60px 0;
          overflow: hidden;
        }

        .static-arrow-grid {
          position: absolute;
          top: 0; left: 0; width: 100%; height: 100%;
          display: grid;
          z-index: -1;
          pointer-events: none;
        }

        .static-arrow-grid .arrow-cell {
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .static-arrow-grid .arrow-icon {
          width: 10px;
          height: 10px;
          border-right: 2px solid var(--color-warm-amber);
          border-bottom: 2px solid var(--color-warm-amber);
          transform: rotate(45deg); /* Point down */
          opacity: 0.25; /* Subtle background */
        }

        .expand-connector {
          width: 2px;
          height: 40px;
          background: repeating-linear-gradient(
            to bottom,
            var(--color-slate-blue),
            var(--color-slate-blue) 4px,
            transparent 4px,
            transparent 8px
          );
          opacity: 0.3;
          margin-bottom: 20px;
        }

        .btn-expand-services {
          background: rgba(255, 255, 255, 0.8);
          backdrop-filter: blur(10px);
          border: 1px solid var(--color-slate-blue);
          color: var(--color-slate-blue);
          padding: 12px 32px;
          border-radius: 50px;
          font-size: 1.1rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 12px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
          outline: none;
        }

        .btn-expand-services:hover {
          background: var(--color-slate-blue);
          color: #ffffff;
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(75, 101, 135, 0.25);
        }

        .btn-expand-services .btn-icon {
          background: var(--color-warm-amber);
          color: var(--color-charcoal);
          width: 24px;
          height: 24px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.8rem;
          transition: transform 0.3s ease;
        }

        .btn-expand-services:hover .btn-icon {
          transform: rotate(90deg);
          background: #ffffff;
          color: var(--color-slate-blue);
        }

        /* Animations */
        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(40px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        /* Responsive */
        @media (max-width: 768px) {
          .services-grid {
            grid-template-columns: 1fr;
          }
          
          .section-header h2 {
            font-size: 2.5rem;
          }
          
          .service-card {
            padding: 30px;
          }
        }
      </style>

      <script>
        function toggleLearnMore(element) {
          const isExpanded = element.getAttribute('aria-expanded') === 'true';
          element.setAttribute('aria-expanded', !isExpanded);
          
          element.classList.toggle('active');
          const content = element.nextElementSibling;
          content.classList.toggle('active');
        }

        function toggleServices() {
          const hiddenServices = document.querySelectorAll('.hidden-service');
          const btn = document.getElementById('toggle-services-btn');
          const btnText = btn.querySelector('.btn-text');
          const btnIcon = btn.querySelector('.btn-icon i');
          
          // Check if services are currently visible (by checking the first one)
          const isHidden = hiddenServices[0].style.display === 'none';

          hiddenServices.forEach(service => {
            if (isHidden) {
              service.classList.add('revealed');
              service.style.display = 'block';
              // Add small stagger effect for reveal
              setTimeout(() => {
                  service.style.opacity = '1';
              }, 50);
            } else {
              service.classList.remove('revealed');
              service.style.display = 'none';
              service.style.opacity = '0';
            }
          });

          if (isHidden) {
            btnText.textContent = 'Show Less';
            btnIcon.className = 'fa fa-minus';
          } else {
            btnText.textContent = 'View Additional Services';
            btnIcon.className = 'fa fa-plus';
             // Smooth scroll back to services top if closing
             document.getElementById('services').scrollIntoView({ behavior: 'smooth' });
          }
        }

        // --- Interactive Arrow Grid Logic ---
        function initArrowGrid() {
          const arrowGrid = document.getElementById('arrow-grid');
          const container = document.querySelector('.interactive-arrow-bar');
          
          if (!arrowGrid || !container) return;
          
          // Dynamic grid calculation for perfect density
          function createArrows() {
            arrowGrid.innerHTML = '';
            const size = 40; // px size of grid cell
            const cols = Math.ceil(container.offsetWidth / size);
            const rows = Math.ceil(container.offsetHeight / size);
            const totalArrows = cols * rows;
            
            arrowGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            for (let i = 0; i < totalArrows; i++) {
              const cell = document.createElement('div');
              cell.className = 'arrow-cell';
              const arrow = document.createElement('div');
              arrow.className = 'arrow-icon';
              cell.appendChild(arrow);
              arrowGrid.appendChild(cell);
            }
          }

          // Initial creation
          createArrows();
          
          // Re-create on resize (debounced)
          let resizeTimeout;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(createArrows, 200);
          });

          const getArrows = () => container.querySelectorAll('.arrow-icon');
          let isRunning = false;
          let mouseX = 0, mouseY = 0;
          let isHovering = false;

          // Animation Loop
          function animate() {
            if (!isRunning) return;
            
            const arrows = getArrows();
            
            arrows.forEach(arrow => {
              // Skip if this is a static arrow (safety check)
              if (arrow.classList.contains('static-arrow')) return;

              const rect = arrow.getBoundingClientRect();
              const arrowCenterX = rect.left + rect.width / 2;
              const arrowCenterY = rect.top + rect.height / 2;
              
              // Angle calculation
              const deltaX = mouseX - arrowCenterX;
              const deltaY = mouseY - arrowCenterY;
              const angleRad = Math.atan2(deltaY, deltaX);
              const angleDeg = angleRad * (180 / Math.PI);
              
              // Distance calculation for "Spotlight Effect"
              const dist = Math.hypot(deltaX, deltaY);
              const maxDist = 400; // Range of effect
              const proximity = Math.max(0, 1 - dist / maxDist);
              
              // Apply styles: Rotate + Scale/Opacity based on proximity
              const scale = 1 + (proximity * 0.3); // Slight scale up
              const opacity = 0.3 + (proximity * 0.7); // Fade out when far
              
              // -45deg adjustment for arrow icon orientation
              arrow.style.transform = `rotate(${angleDeg - 45}deg) scale(${scale})`;
              arrow.style.opacity = isHovering ? opacity : 0.3;
            });
            
            isRunning = false; 
          }

          // Event Listeners
          container.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            isHovering = true;
            
            if (!isRunning) {
              isRunning = true;
              window.requestAnimationFrame(animate);
            }
          });

          container.addEventListener('mouseleave', () => {
             isHovering = false;
             // Optional: Reset arrows or leave them as last position
             // Let's trigger one last animation frame to reset opacities
             if (!isRunning) {
              isRunning = true;
              window.requestAnimationFrame(animate);
            }
          });
        }

        // Run initialization
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initArrowGrid);
          document.addEventListener('DOMContentLoaded', initStaticArrows);
        } else {
          initArrowGrid();
          initStaticArrows();
        }

        // --- Static Arrow Grid Logic (Bottom) ---
        function initStaticArrows() {
          const grid = document.getElementById('static-arrow-grid');
          if (!grid) return;

          function createStaticArrows() {
            grid.innerHTML = '';
            const size = 60; // Larger spacing for static grid
            const cols = Math.ceil(grid.offsetWidth / size);
            const rows = Math.ceil(grid.offsetHeight / size);
            const totalArrows = cols * rows;
            
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            for (let i = 0; i < totalArrows; i++) {
              const cell = document.createElement('div');
              cell.className = 'arrow-cell';
              const arrow = document.createElement('div');
              arrow.className = 'arrow-icon static-arrow';
              cell.appendChild(arrow);
              grid.appendChild(cell);
            }
          }

          createStaticArrows();
          
          let resizeTimeout;
          window.addEventListener('resize', () => {
             clearTimeout(resizeTimeout);
             resizeTimeout = setTimeout(createStaticArrows, 200);
          });
        }

        // Add intersection observer for scroll animations
        const observerOptions = {
          threshold: 0.1,
          rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              // Only animate if it's visible (not hidden by toggle)
              if (entry.target.style.display !== 'none') {
                  entry.target.style.animationPlayState = 'running';
              }
            }
          });
        }, observerOptions);

        document.querySelectorAll('.service-card').forEach(card => {
          card.style.animationPlayState = 'paused';
          observer.observe(card);
        });
      </script>
    </section>
  {{ end }}
{{ end }}
